<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookayFlorists - Categories</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <style>
        body {
            overflow-x: hidden;
        }

        .container-fluid {
            margin-top: 2rem;
        }

        .categories-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .categories-header h2 {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .btn-add-category {
            background-color: #198754;
            color: #fff;
            font-weight: bold;
        }

        .btn-add-category:hover {
            background-color: #157347;
        }

        .table thead th {
            background-color: #198754;
            color: #fff;
        }

        .btn-edit {
            background-color: #ffc107;
            color: #fff;
        }

        .btn-view {
            background-color: #007bff;
            color: #fff;
        }

        .btn-delete {
            background-color: #dc3545;
            color: #fff;
        }

        .modal-header {
            background-color: #198754;
            color: #fff;
        }

        .modal-footer .btn-close,
        .modal-footer .btn-save {
            background-color: #198754;
            color: #fff;
        }

        .modal-footer .btn-close:hover,
        .modal-footer .btn-save:hover {
            background-color: #157347;
        }

        .category-body {
            min-height: 82vh;
        }
    </style>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark custom-navbar">
            <a class="navbar-brand" href="#Home">
                <img src="./assets/images/Bookay_Logo_plain.png" alt="BookayFlorists Logo"
                    style="height: 100px; width: auto; margin-left: 40px;">
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Services</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Gallery</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Contact</a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <div class="container-fluid category-body">
        <div class="categories-header">
            <h2>Flower Categories</h2>
            <button class="btn btn-add-category" data-toggle="modal" data-target="#addCategoryModal">Add New Category</button>
            <button class="btn btn-danger m-3" onclick="logout()">Logout</button>
        </div>

        <div id="flashMessageContainer" class="container mt-3">
            <!-- Flash messages will be dynamically added here -->
        </div>
        
        <!-- Categories Table -->
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Category Name</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="categoryTableBody">
                <!-- Rows will be dynamically added here -->
            </tbody>
        </table>
    </div>

    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">Add New Category</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    
                </div>
                <div class="modal-body">
                    <form id="addCategoryForm">
                        <div class="form-group">
                            <label for="categoryName">Category Name</label>
                            <input type="text" class="form-control" id="categoryName" placeholder="Enter category name" required>
                        </div>
                        <div class="form-group">
                            <label for="categoryDescription">Description</label>
                            <textarea class="form-control" id="categoryDescription" rows="3" placeholder="Enter category description" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-close" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-save" onclick="addCategory()">Save Category</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editCategoryForm">
                        <input type="hidden" id="editCategoryId">
                        <div class="form-group">
                            <label for="editCategoryName">Category Name</label>
                            <input type="text" class="form-control" id="editCategoryName" required>
                        </div>
                        <div class="form-group">
                            <label for="editCategoryDescription">Description</label>
                            <textarea class="form-control" id="editCategoryDescription" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-close" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-save" onclick="saveCategory()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteCategoryModalLabel">Delete Category</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this category? Deleting this category will also delete all the flowers in this category.</p>
                    <input type="hidden" id="deleteCategoryId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteCategory()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <h5>Company</h5>
                    <ul class="list-unstyled">
                        <li><a href="#">Home</a></li>
                        <li><a href="#">Services</a></li>
                        <li><a href="#">About us</a></li>
                        <li><a href="#">Blog</a></li>
                        <li><a href="#">Contact</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <h5>Contact us</h5>
                    <ul class="list-unstyled">
                        <li>Phone: +254712203076</li>
                        <li>Mail: bookayflorists@gmail.com</li>
                        <li>Freedom Heights, 5th floor<br>Langata, Kenya</li>
                    </ul>
                </div>
                <div class="footer-bottom">
                    <div class="container text-center">
                        <p>Copyright © BookayFlorists 2024</p>
                        <div class="social-icons">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-pinterest"></i></a>
                            <a href="#"><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Supabase Initialization and Script -->
    <script>
        const supabaseUrl = 'https://rdqaxqagqyylxvdksnzi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkcWF4cWFncXl5bHh2ZGtzbnppIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcyMzkyNjk5NywiZXhwIjoyMDM5NTAyOTk3fQ.BCgpL_7mNghbz_Y7uQgVRhjjIAh5zCuwHKltD3VtZIU'; // Replace this with your actual Supabase key
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Function to show flash messages
        function showFlashMessage(message, type = 'success') {
            const flashMessageContainer = document.getElementById('flashMessageContainer');
            const alertType = type === 'success' ? 'alert-success' : 'alert-danger';
            const alertMessage = `
                <div class="alert ${alertType} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            flashMessageContainer.innerHTML = alertMessage;

            // Automatically remove the flash message after a few seconds
            setTimeout(() => {
                $('.alert').alert('close');
            }, 3000);
        }

        // Function to check if the user is authenticated and has the admin role
        async function checkAuth() {
            // Get the current session
            const { data: { session }, error } = await supabaseClient.auth.getSession();

            if (error || !session) {
                // If no session exists, redirect to login page
                window.location.href = 'login.html';
                return;
            }

            // If the session exists, the user is authenticated, proceed with loading the page
            console.log('User is authenticated:', session.user);
        }

        // Call the checkAuth function when the page loads
        checkAuth();

        
        async function fetchCategories() {
            const { data, error } = await supabaseClient
                .from('categories')
                .select('*');

            if (error) {
                console.error('Error fetching categories:', error);
                showFlashMessage('Failed to fetch categories. Please try again.', 'error');
                return;
            }

            if (data.length === 0) {
                showFlashMessage('No categories found.', 'info');
                return;
            }

            const tableBody = document.getElementById('categoryTableBody');
            tableBody.innerHTML = ''; // Clear any existing rows

            data.forEach(category => {
                const row = document.createElement('tr');

                const idCell = document.createElement('td');
                idCell.textContent = category.id;
                row.appendChild(idCell);

                const nameCell = document.createElement('td');
                nameCell.textContent = category.category_name;
                row.appendChild(nameCell);

                const descriptionCell = document.createElement('td');
                descriptionCell.textContent = category.description || '';
                row.appendChild(descriptionCell);

                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <button class="btn btn-view btn-sm" onclick="viewCategory(${category.id})">View</button>
                    <button class="btn btn-edit btn-sm" onclick="showEditCategoryModal(${category.id}, '${category.category_name}', '${category.description || ''}')">Edit</button>
                    <button class="btn btn-delete btn-sm" onclick="showDeleteCategoryModal(${category.id})">Delete</button>
                `;
                row.appendChild(actionsCell);

                tableBody.appendChild(row);
            });
        }

        // Fetch categories when the page loads
        fetchCategories();


        // Function to add a new category
        async function addCategory() {
            const categoryName = document.getElementById('categoryName').value;
            const categoryDescription = document.getElementById('categoryDescription').value;

            const { data, error } = await supabaseClient
                .from('categories')
                .insert([{ category_name: categoryName, description: categoryDescription }]);

            if (error) {
                console.error('Error adding category:', error);
                showFlashMessage('Failed to add category. Please try again.', 'error');
            } else {
                $('#addCategoryModal').modal('hide');
                fetchCategories(); // Refresh the categories table
                showFlashMessage('Category added successfully!');
            }
        }

        // Function to show the edit category modal and populate the fields
        function showEditCategoryModal(id, name, description) {
            document.getElementById('editCategoryId').value = id;
            document.getElementById('editCategoryName').value = name;
            document.getElementById('editCategoryDescription').value = description;
            $('#editCategoryModal').modal('show');
        }

        // Function to save the edited category
        async function saveCategory() {
            const categoryId = document.getElementById('editCategoryId').value;
            const categoryName = document.getElementById('editCategoryName').value;
            const categoryDescription = document.getElementById('editCategoryDescription').value;

            const { data, error } = await supabaseClient
                .from('categories')
                .update({ category_name: categoryName, description: categoryDescription })
                .eq('id', categoryId);

            if (error) {
                console.error('Error updating category:', error);
                showFlashMessage('Failed to update category. Please try again.', 'error');
            } else {
                $('#editCategoryModal').modal('hide');
                fetchCategories(); // Refresh the categories table
                showFlashMessage('Category updated successfully!');
            }
        }

        // Function to show the delete confirmation modal
        function showDeleteCategoryModal(categoryId) {
            document.getElementById('deleteCategoryId').value = categoryId;
            $('#deleteCategoryModal').modal('show');
        }

        // Function to confirm deletion after the warning
        async function confirmDeleteCategory() {
            const categoryId = document.getElementById('deleteCategoryId').value;

            const { data, error } = await supabaseClient
                .from('categories')
                .delete()
                .eq('id', categoryId);

            if (error) {
                console.error('Error deleting category:', error);
                showFlashMessage('Failed to delete category. Please try again.', 'error');
            } else {
                $('#deleteCategoryModal').modal('hide');
                fetchCategories(); // Refresh the categories table
                showFlashMessage('Category deleted successfully!');
            }
        }

        // Function to handle the View button click
        function viewCategory(categoryId) {
            window.location.href = `category-flowers.html?category_id=${categoryId}`;
        }

        // Function to handle logout
        async function logout() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                console.error('Error logging out:', error.message);
            } else {
                // Redirect to login page after successful logout
                window.location.href = 'login.html';
            }
        }
    </script>

    <!-- jQuery and Bootstrap Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>
